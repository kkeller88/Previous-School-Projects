---
title: "DAP1_bayes"
author: "Kristen Keller"
date: "November 10, 2016"
output: pdf_document
---

PREPARE WORKSPACE (YES)
```{r}
# libraries
library(knitr) # kable
library(R2jags) # jags

# working directory
setwd("~/Documents/UCLA/CLASSES/234 bayes/DAP1")
```

MODEL (NO)
```{r}
# DATA: i = 1...11 studies j=1..2 ar the treatments
#       ni1 = number of people recieving CABG (Coronary Artery Bypass Surgery) 
#       ni2 = numer of people recieving stents / PCI (Percutaneous coronary intervention)
#       fi1 = number of people in CABG group that died in one year
#       fi2 = number of people in PCI group that died in one year
#
# Question: Which group is death rate higher in?
# Question: What is the typical death rate for people who recieve T1 and T2?


# Build model:
# Note: range of delta should be negative
# 
sink("DAP1.txt")
cat("
    model
  {  
  
    for (i in 1:N){
      
      for (j in 1:2){
        y[i,j] ~ dbinom(pie[i,j],n[i,j])
      }   
  
      pie[i,1] <- ilogit(mu[i]-delta[i]/2) ########## is this right
      pie[i,2] <- ilogit(mu[i]+delta[i]/2)
  
      mu[i] ~ dnorm(mu0,sigma2)
      delta[i] ~ dnorm(delta0,tau2)
     
      x1[i] <- mu[i] - delta[i]/2 # individual group 
      x2[i] <- mu[i] + delta[i]/2 
    }
    mu0 ~ dnorm(mu.a,mu.b)
    sigma2 ~ dgamma(sigma2.a,sigma2.b) 
    delta0 ~ dnorm(delta.a,delta.b)
    tau2 ~ dgamma(tau2.a,tau2.b)
  
    var_mu <- 1/sigma2
    var_delta <- 1/tau2
    
    x1_mean <- mean(x1)
    x2_mean <- mean(x2)
	}
    ",fill = TRUE)
sink()
```

ORIGINAL: DATA, INITS, PARAMS (YES)
```{r}
# note: gamma paramaterization --> alpha, 1/beta ---> alplha/beta=mean, alpha/beta^2
# 
# mean: 0.875 
# var: 1/0.25 = 4
# a/b = 0.875; a=0.875b; 
# a/b^2 = 4; a=4b^2
# b = 0.21875; a = 0.1914062
# 
# mean: 0.5
# var:  100
# a/b = .5; a=0.5b 
# a/b^2 = 100; a=100b^2
# a = .0025
# b = .005

#### data 
mu.a = -2.752
mu.b = 9.028
sigma2.a = 0.1914062
sigma2.b = 0.21875
delta.a = 0.358
delta.b = 2.149
tau2.a = .0025
tau2.b = .005
N = 11
n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80))
y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))

# Just need this
N = 11
data1 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5)))

# params
params1 <- c("mu","pie","delta","var_mu","var_delta","mu0","delta0","x1_mean","x2_mean")

# inits
inits1 <- rep((list(list(mu=rep(0,N), delta=rep(0,N)))),3)
 
set.seed(883)
model1 <- jags (data1, inits1, params1, "DAP1.txt", n.chains=3, n.iter=5000, n.burnin=0, n.thin=1, DIC=FALSE)
```

SUMMARY: 1st run (YES)
```{r}
##### extract data
temp1=apply(model1$BUGSoutput$sims.array,3,unlist)

delta1 <- temp1[,1:11]; mu1 <- temp1[,13:23]
pie1 <- temp1[,25:46]; pie1_1 <- temp1[,25:35]; pie1_2 <- temp1[,36:46]
mu0delta0 <- temp1[,c(12,24,47,48)]

##### summarize
mysummary = function(invector) {
c(mean(invector), sd(invector), quantile(invector, .025), quantile(invector,.975),
  length(invector[invector<0])/length(invector),length(invector[invector==0])/length(invector),length(invector[invector>0])/length(invector))
}

summary_all_1<-apply(temp1, 2, mysummary)
  rownames(summary_all_1)=c("Mean","SD","95% CI Low","95% CI High","% Positive")
summary_main_parms_1<-apply(mu0delta0, 2, mysummary)
  rownames(summary_main_parms_1)=c("Mean","SD","95% CI Low","95% CI High","% Positive")

##### smaller summary
mysummary2 = function(invector) {
c(mean(invector), sd(invector), quantile(invector, .025), quantile(invector,.975))
}


```

ASSESSING CONVERGENCE (NO)
```{r}
#################################### AUTOCORRELATION

# par(mfrow=c(2,2))
acf(delta1[,1],lag.max=100) # low 70s
acf(delta1[,2],lag.max=100) # high 70s
acf(delta1[,3],lag.max=200) # around 175
acf(delta1[,4],lag.max=100) # around 70
acf(delta1[,5],lag.max=100) # mid 60s
acf(delta1[,6],lag.max=100) # around 80
acf(delta1[,7],lag.max=100) # around 70
acf(delta1[,8],lag.max=100) # high 70s
acf(delta1[,9],lag.max=150) # 140
acf(delta1[,10],lag.max=100) # mid 80s
acf(delta1[,11],lag.max=100) # high 60s

acf(mu1[,1],lag.max=100) # mid 60s
acf(mu1[,2],lag.max=100) # mid 50s
acf(mu1[,3],lag.max=100) # 70
acf(mu1[,4],lag.max=100) # low 40s
acf(mu1[,5],lag.max=100) # mid 50s
acf(mu1[,6],lag.max=100) # low 50s
acf(mu1[,7],lag.max=100) # 70
acf(mu1[,8],lag.max=200) # 120
acf(mu1[,9],lag.max=100) # low 40s
acf(mu1[,10],lag.max=100) # high 40s
acf(mu1[,11],lag.max=100) # 60 

acf(pie[,1],lag.max=100) # low 40s
acf(pie1[,2],lag.max=100) # mid 50s
acf(pie1[,3],lag.max=100) # 175-200
acf(pie1[,4],lag.max=100) # 70s
acf(pie1[,5],lag.max=100) # 60
acf(pie1[,6],lag.max=100) # 50
acf(pie1[,7],lag.max=100) # high 60
acf(pie1[,8],lag.max=150) # 125
acf(pie1[,9],lag.max=200) # 170
acf(pie1[,10],lag.max=100) # 40
acf(pie1[,11],lag.max=100) # mid 50s
acf(pie1[,12],lag.max=100) # 60
acf(pie1[,13],lag.max=100) # mid 50s
acf(pie1[,14],lag.max=100) # 60
acf(pie1[,15],lag.max=100) # 80-
acf(pie1[,16],lag.max=100) # 70-
acf(pie1[,17],lag.max=100) # 
acf(pie1[,18],lag.max=100) # 70-
acf(pie1[,19],lag.max=100) # 80-
acf(pie1[,20],lag.max=100) # 30s
acf(pie1[,21],lag.max=100) # 35
acf(pie1[,22],lag.max=100) # 100

acf(mu0delta0[,1],lag.max=100)
acf(mu0delta0[,2],lag.max=100)
acf(mu0delta0[,3],lag.max=100)
acf(mu0delta0[,4],lag.max=100)

#################################### TIME SERIS

# main variables
delta0 <- mu0delta0[,1]
mu0 <- mu0delta0[,2]
delta_var <- mu0delta0[,3]
mu_var <- mu0delta0[,4]

plot(delta0,type="l")
plot(mu0,type="l")
plot(delta_var,type="l")
plot(mu_var,type="l")

# other
plot(mu1[,1],type="l")
plot(mu1[,2],type="l")
plot(mu1[,3],type="l")
plot(mu1[,4],type="l")
plot(mu1[,5],type="l")
plot(mu1[,6],type="l")
plot(mu1[,7],type="l")
plot(mu1[,8],type="l")
plot(mu1[,9],type="l")
plot(mu1[,10],type="l")
plot(mu1[,11],type="l")
plot(mu1[,1],type="l")

plot(delta[,1],type="l") ############################ delta horrile
plot(pie[,1],type="l")
plot(delta[,4],type="l")
```

RUN 2: 70,000 runs rather than 5,000 (Yes)
```{r}
set.seed(883)
model2 <- jags (data1, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)

##### extract data
temp2=apply(model2$BUGSoutput$sims.array,3,unlist)

delta2 <- temp2[,1:11]; mu2 <- temp2[,13:23]
pie2 <- temp2[,25:46]; pie2_1 <- temp2[,25:35]; pie2_2 <- temp2[,36:46]
main_parms2 <- temp2[,c(12,24,47,48)]; group_means <- temp2[,c(49,50)]

##### summary
summary_all_2<-apply(temp2, 2, mysummary)
  rownames(summary_all_2)=c("Mean","SD","95% CI Low","95% CI High","% Negative","% Zero","% Positive")
summary_main_parms_2<-t(apply(main_parms2, 2, mysummary))
  colnames(summary_main_parms_2)=c("Mean","SD","95% CI Low","95% CI High","Negative","% Zero","% Positive")

######################## density
plot(density(main_parms2[,1])) # delta0
plot(density(main_parms2[,2])) # mu0
plot(density(main_parms2[,3])) # var_delta
plot(density(main_parms2[,4])) # var_mu

plot(density(delta1[,1]))
plot(density(delta1[,2]))
plot(density(delta1[,3]))
plot(density(delta1[,4]))
plot(density(delta1[,5]))
plot(density(delta1[,6]))
plot(density(delta1[,7]))
plot(density(delta1[,8]))
plot(density(delta1[,9]))
plot(density(delta1[,10]))
plot(density(delta1[,11]))

plot(density(mu1[,1]))
plot(density(mu1[,2]))
plot(density(mu1[,3]))
plot(density(mu1[,4]))
plot(density(mu1[,5]))
plot(density(mu1[,6]))
plot(density(mu1[,7]))
plot(density(mu1[,8]))
plot(density(mu1[,9]))
plot(density(mu1[,10]))
plot(density(mu1[,11]))

plot(density(exp(mu1[,1])/(1+exp(mu1[,1]))))
plot(density(exp(mu1[,2])/(1+exp(mu1[,2]))))
plot(density(exp(mu1[,3])/(1+exp(mu1[,3]))))
plot(density(exp(mu1[,4])/(1+exp(mu1[,4]))))

```



SENSITIVITY ANALYSIS: MODELS
```{r}
data3 <- list(mu.a = -4.75, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data4 <- list(mu.a = -1.75, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data5 <- list(mu.a = -2.752, mu.b = 1, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data6 <- list(mu.a = -2.752, mu.b = 20, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data7 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 2.504, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) # 

data8 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = -2.504, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data9 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 0.1, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data10 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 10, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data11 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.01, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data12 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 3, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data13 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.01, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data14 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.1, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data15 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0001, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data16 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .1, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data17 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .0001, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #

data18 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .1, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))) #


### run models
set.seed(897)
model3 <- jags (data3, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model4 <- jags (data4, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model5 <- jags (data5, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model6 <- jags (data6, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model7 <- jags (data7, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model8 <- jags (data8, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model9 <- jags (data9, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model10 <- jags (data10, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model11 <- jags (data11, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model12 <- jags (data12, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model13 <- jags (data13, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model14 <- jags (data14, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model15 <- jags (data15, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model16 <- jags (data16, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model17 <- jags (data17, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)
model18 <- jags (data18, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)

```

MODEL KEY
```{r}
# 1: original parameters - 5,000 iterations
# 2: original parameters - 70,000 iterations
# 3: mu0 - mean -4.75 var 
# 4: mu0 - mean -1.75 var 
# 5: mu0 - prec 1 
# 6: mu0 - prec 20 
# 7: delta0  - mean 2.504
# 8: delta0 - mean -2.504
# 9: delta0 - var 0.1
# 10: delta0 - var 10
# 11: sigma2 - a 0.01
# 12: sigma2 - a 3  
# 13: sigma2 - b 0.01
# 14: sigma2 - b 3    
# 15: tau - a 0.0001
# 16: tau - b 0.1
# 17: tau - a 0.0001
# 18: tau - b 0.1

data1 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5)))
```

PROCESS MODEL OUTPUT: DISTRIBUTION OF DELTA0
```{r}
temp3=apply(model3$BUGSoutput$sims.array,3,unlist)
temp4=apply(model4$BUGSoutput$sims.array,3,unlist)
temp5=apply(model5$BUGSoutput$sims.array,3,unlist)
temp6=apply(model6$BUGSoutput$sims.array,3,unlist)
temp7=apply(model7$BUGSoutput$sims.array,3,unlist)
temp8=apply(model8$BUGSoutput$sims.array,3,unlist)
temp9=apply(model9$BUGSoutput$sims.array,3,unlist)
temp10=apply(model10$BUGSoutput$sims.array,3,unlist)
temp11=apply(model11$BUGSoutput$sims.array,3,unlist)
temp12=apply(model12$BUGSoutput$sims.array,3,unlist)
temp13=apply(model13$BUGSoutput$sims.array,3,unlist)
temp14=apply(model14$BUGSoutput$sims.array,3,unlist)
temp15=apply(model15$BUGSoutput$sims.array,3,unlist)
temp16=apply(model16$BUGSoutput$sims.array,3,unlist)
temp17=apply(model17$BUGSoutput$sims.array,3,unlist)
temp18=apply(model18$BUGSoutput$sims.array,3,unlist)

main_parms3 <- temp3[,c(12,24,47,48)]
main_parms4 <- temp4[,c(12,24,47,48)]
main_parms5 <- temp5[,c(12,24,47,48)]
main_parms6 <- temp6[,c(12,24,47,48)]
main_parms7 <- temp7[,c(12,24,47,48)]
main_parms8 <- temp8[,c(12,24,47,48)]
main_parms9 <- temp9[,c(12,24,47,48)]
main_parms10 <- temp10[,c(12,24,47,48)]
main_parms11 <- temp11[,c(12,24,47,48)]
main_parms12 <- temp12[,c(12,24,47,48)]
main_parms13 <- temp13[,c(12,24,47,48)]
main_parms14 <- temp14[,c(12,24,47,48)]
main_parms15 <- temp15[,c(12,24,47,48)]
main_parms16 <- temp16[,c(12,24,47,48)]
main_parms17 <- temp17[,c(12,24,47,48)]
main_parms18 <- temp18[,c(12,24,47,48)]

delta_3 <- mysummary2(main_parms3[,1])
delta_4 <- mysummary2(main_parms4[,1])
delta_5 <- mysummary2(main_parms5[,1])
delta_6 <- mysummary2(main_parms6[,1])
delta_7 <- mysummary2(main_parms7[,1])
delta_8 <- mysummary2(main_parms8[,1])
delta_9 <- mysummary2(main_parms9[,1])
delta_10 <- mysummary2(main_parms10[,1])
delta_11 <- mysummary2(main_parms11[,1])
delta_12 <- mysummary2(main_parms12[,1])
delta_13 <- mysummary2(main_parms13[,1])
delta_14 <- mysummary2(main_parms14[,1])
delta_15 <- mysummary2(main_parms15[,1])
delta_16 <- mysummary2(main_parms16[,1])
delta_17 <- mysummary2(main_parms17[,1])
delta_18 <- mysummary2(main_parms18[,1])
delta_2 <- mysummary2(main_parms2[,1])

# individual values
delta_table1 <- rbind(delta_2,delta_3,delta_4,delta_5,delta_6,delta_7,delta_8,delta_9,delta_10,delta_11,delta_12,delta_13,delta_14,delta_15,delta_16,delta_17,delta_18)

# better format
delta_table2 <- rbind(delta_3,delta_2,delta_4,delta_5,delta_2,delta_6,delta_7,delta_2,delta_8,delta_9,delta_2,delta_10,delta_11,delta_2,delta_12,delta_13,delta_2,delta_14,delta_15,delta_2,delta_16,delta_17,delta_2,delta_18)
delta_table2<-round(delta_table2,3)
colnames(delta_table2)<-c("Mean","SD","95% CI Low","95% CI High")
rownames(delta_table2)<-c("mean m0 = -4.75","mean m0 = -2.753","mean m0 = -1.75","var m0 = 1","var m0 = 9.028","var m0 = 20","mean delta0 = 2.504","mean delta0 = 0.358","mean delta0 = -2.504","var delta0 = 0.1","var delta0 = 2.149","var delta0 = 10","sigma2 a = 0.01","sigma2 a = 0.191","sigma2 b = 3","sigma2 b = 0.01","sigma2 b = 0.219","sigma2 b = 3","tau2 a = 0.0001","tau2 a = 0.0025","tau2 a = 0.1","tau2 b = 0.0001","tau2 b = 0.005","tau2 b = 0.1")

# fixed order
delta_table3 <- rbind(delta_3,delta_2,delta_4,delta_5,delta_2,delta_6,delta_8,delta_2,delta_7,delta_9,delta_2,delta_10,delta_11,delta_2,delta_12,delta_13,delta_2,delta_14,delta_15,delta_2,delta_16,delta_17,delta_2,delta_18)
delta_table3<-round(delta_table2,3)
colnames(delta_table3)<-c("Mean","SD","95% CI Low","95% CI High")
rownames(delta_table3)<-c("mean m0 = -4.75","mean m0 = -2.753","mean m0 = -1.75","var m0 = 1","var m0 = 9.028","var m0 = 20","mean delta0 = -2.504","mean delta0 = 0.358","mean delta0 = 2.504","var delta0 = 0.1","var delta0 = 2.149","var delta0 = 10","sigma2 a = 0.01","sigma2 a = 0.191","sigma2 b = 3","sigma2 b = 0.01","sigma2 b = 0.219","sigma2 b = 3","tau2 a = 0.0001","tau2 a = 0.0025","tau2 a = 0.1","tau2 b = 0.0001","tau2 b = 0.005","tau2 b = 0.1")

# write.csv(delta_table1,"all_delta_distrs.csv")
# write.csv(delta_table2,"all_delta_distrs_with_original.csv")
# write.csv(delta_table3,"delta0_table_sensitivity.csv")
```

PROCESS MODEL OUTPUT: DISTRIBUTION OF MEAN DELTAi
```{r}
delta2 <- temp2[,1:11]
delta3 <- temp3[,1:11]
delta4 <- temp4[,1:11]
delta5 <- temp5[,1:11]
delta6 <- temp6[,1:11]
delta7 <- temp7[,1:11]
delta8 <- temp8[,1:11]
delta9 <- temp9[,1:11]
delta10 <- temp10[,1:11]
delta11 <- temp11[,1:11]
delta12 <- temp12[,1:11]
delta13 <- temp13[,1:11]
delta14 <- temp14[,1:11]
delta15 <- temp15[,1:11]
delta16 <- temp16[,1:11]
delta17 <- temp17[,1:11]
delta18 <- temp18[,1:11]

delta_mean_2 <- apply(delta2,1,mean)
delta_mean_3 <- apply(delta3,1,mean)
delta_mean_4 <- apply(delta4,1,mean)
delta_mean_5 <- apply(delta5,1,mean)
delta_mean_6 <- apply(delta6,1,mean)
delta_mean_7 <- apply(delta7,1,mean)
delta_mean_8 <- apply(delta8,1,mean)
delta_mean_9 <- apply(delta9,1,mean)
delta_mean_10 <- apply(delta10,1,mean)
delta_mean_11 <- apply(delta11,1,mean)
delta_mean_12 <- apply(delta12,1,mean)
delta_mean_13 <- apply(delta13,1,mean)
delta_mean_14 <- apply(delta14,1,mean)
delta_mean_15 <- apply(delta15,1,mean)
delta_mean_16 <- apply(delta16,1,mean)
delta_mean_17 <- apply(delta17,1,mean)
delta_mean_18 <- apply(delta18,1,mean)

delta_3 <- mysummary2(delta_mean_3)
delta_4 <- mysummary2(delta_mean_4)
delta_5 <- mysummary2(delta_mean_5)
delta_6 <- mysummary2(delta_mean_6)
delta_7 <- mysummary2(delta_mean_7)
delta_8 <- mysummary2(delta_mean_8)
delta_9 <- mysummary2(delta_mean_9)
delta_10 <- mysummary2(delta_mean_10)
delta_11 <- mysummary2(delta_mean_11)
delta_12 <- mysummary2(delta_mean_12)
delta_13 <- mysummary2(delta_mean_13)
delta_14 <- mysummary2(delta_mean_14)
delta_15 <- mysummary2(delta_mean_15)
delta_16 <- mysummary2(delta_mean_16)
delta_17 <- mysummary2(delta_mean_17)
delta_18 <- mysummary2(delta_mean_18)
delta_2 <- mysummary2(delta_mean_2)


# fixed order
delta_table3 <- rbind(delta_3,delta_2,delta_4,delta_5,delta_2,delta_6,delta_8,delta_2,delta_7,delta_9,delta_2,delta_10,delta_11,delta_2,delta_12,delta_13,delta_2,delta_14,delta_15,delta_2,delta_16,delta_17,delta_2,delta_18)
delta_table3<-round(delta_table2,3)
colnames(delta_table3)<-c("Mean","SD","95% CI Low","95% CI High")
rownames(delta_table3)<-c("mean m0 = -4.75","mean m0 = -2.753","mean m0 = -1.75","var m0 = 1","var m0 = 9.028","var m0 = 20","mean delta0 = -2.504","mean delta0 = 0.358","mean delta0 = 2.504","var delta0 = 0.1","var delta0 = 2.149","var delta0 = 10","sigma2 a = 0.01","sigma2 a = 0.191","sigma2 b = 3","sigma2 b = 0.01","sigma2 b = 0.219","sigma2 b = 3","tau2 a = 0.0001","tau2 a = 0.0025","tau2 a = 0.1","tau2 b = 0.0001","tau2 b = 0.005","tau2 b = 0.1")
# write.csv(delta_table3,"deltai_mean_table_sensitivity.csv")


```

Sensitivity Analysis 2
```{r}
data19 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = -1, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5)))

data20 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 1, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5)))

data21 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.5, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5)))

data22 <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = -0.5, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)), y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5)))

7,19,22,2,21,20,8

model19 <- jags (data19, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)

model20 <- jags (data20, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)

model21 <- jags (data21, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)

model22 <- jags (data22, inits1, params1, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)

temp19=apply(model19$BUGSoutput$sims.array,3,unlist)
temp20=apply(model20$BUGSoutput$sims.array,3,unlist)
temp21=apply(model21$BUGSoutput$sims.array,3,unlist)
temp22=apply(model22$BUGSoutput$sims.array,3,unlist)

main_parms19 <- temp19[,c(12,24,47,48)]
main_parms20 <- temp20[,c(12,24,47,48)]
main_parms21 <- temp21[,c(12,24,47,48)]
main_parms22 <- temp22[,c(12,24,47,48)]


```

PLOTS TO USE IN PAPER
```{r}
# ACF - representative plots
par(mfrow=c(2,2),mar=c(3,4.3,3.5,3))
acf(delta1[,10],lag.max=100,main="Autocorrelation Delta[10]")
acf(mu1[,5],lag.max=100,main="Autocorrelation Mu[5]")
acf(pie1[,15],lag.max=100,main="Autocorrelation Pi[4,2]") 
acf(mu0delta0[,2],lag.max=100,main="Autocorrelation Mu0") 

acf(delta2[,11],lag.max=100)
acf(mu2[,6],lag.max=100)
acf(pie2[,15],lag.max=100) 

# time series
plot(delta0,type="l")
plot(mu0,type="l")
plot(delta_var,type="l")
plot(mu_var,type="l")

plot(delta2[,10],type="l",main="Time Series Delta[10]")
plot(mu2[,5],type="l",main="Time Series Mu[5]")
plot(pie2[,15],type="l",main="Time Series Pi[4,2]")
plot(main_parms2[,2],type="l",main="Time Series Mu0")

# densities
plot(density(main_parms2[,1]),main="Delta0")
plot(density(main_parms2[,2]),main="Mu0")
plot(density(main_parms2[,3]),main="1/Tau Squared")
plot(density(main_parms2[,4]),main="1/Sigma Squared")

########### table 1 
delta2_meani <- apply(delta2,1,mean) 
mu2_meani <- apply(mu2,1,mean) 
tabl1 <- rbind(summary_main_parms_2,mysummary(delta2_meani),mysummary(mu2_meani),mysummary(group_means[,1]),mysummary(group_means[,2]))
rownames(tabl1)[5:8]<-c("deltai mean","mui mean","Group 1 mean","Group 2 mean")
tabl1<-round(tabl1,2)

write.csv(tabl1,file="Summary_Model2_Main.csv")

########### sensitivity analysis plot
par(mfrow=c(2,2),mar=c(2.2,4,3,1))
plot(density(main_parms7[,1]),lty=2,ylim=c(0,3),xlim=c(-1,2),main="Delta0 Mean (Logit)")
lines(density(main_parms2[,1]),lty=1)
lines(density(main_parms8[,1]),lty=3)
legend(0.8,3,legend=c("-2.504","0.358","2.504"),lty=c(2,1,3),cex=0.65)

plot(density(main_parms9[,1]),xlim=c(-1,2),ylim=c(0,3),lty=2,main="Delta0 Var (Logit)")
lines(density(main_parms2[,1]),lty=1)
lines(density(main_parms10[,1]),lty=3)
legend(0.8,3,c("0.1","2.149","10"),lty=c(2,1,3),cex=0.65)

plot(density(exp(main_parms7[,1])/(1+exp(main_parms7[,1]))),ylim=c(0,11),xlim=c(0.15,0.85),lty=2,main="Delta0 Mean (Probability)")
lines(density(exp(main_parms2[,1])/(1+exp(main_parms2[,1]))),lty=1)
lines(density(exp(main_parms8[,1])/(1+exp(main_parms8[,1]))),lty=3)
legend(0.6,11,legend=c("-2.504","0.358","2.504"),lty=c(2,1,3),cex=0.65)

plot(density(exp(main_parms9[,1])/(1+exp(main_parms9[,1]))),xlim=c(0.15,0.85),ylim=c(0,11),lty=2,main="Delta0 Var (Probability)")
lines(density(exp(main_parms2[,1])/(1+exp(main_parms2[,1]))),lty=1)
lines(density(exp(main_parms10[,1])/(1+exp(main_parms10[,1]))),lty=3)
legend(0.6,11,c("0.1","2.149","10"),lty=c(2,1,3),cex=0.65)

################## sensitiviy2 2 
7,19,22,2,21,20,8

# plot(density(exp(main_parms7[,1])/(1+exp(main_parms7[,1]))),xlim=c(0.15,0.85),ylim=c(0,11),lty=1,main="Delta0 Var (Probability)")

plot(density(main_parms19[,1]),xlim=c(-1,2),ylim=c(0,3),lty=3,main="Delta0 Distribution (Logit Scale)",lwd=2)
# lines(density(exp(main_parms19[,1])/(1+exp(main_parms19[,1]))),lty=2)
lines(density(main_parms22[,1]),lty=2,lwd=2)
lines(density(main_parms2[,1]),lty=1,lwd=2)
lines(density(main_parms21[,1]),lty=4,lwd=2)
lines(density(main_parms20[,1]),lty=5,lwd=2)
# lines(density(exp(main_parms8[,1])/(1+exp(main_parms8[,1]))),lty=3,lwd=2)
legend("topright",c("-1","-0.5","0.358","0.5","1"),lty=c(3,2,1,4,5),cex=0.9,lwd=2,bty="n")


################# PRIOR - DATA - POSTERIOR 

# posterior
params2 <- c("mu","pie","delta","var_mu","var_delta","mu0","delta0","x1_mean","x2_mean","tau2","sigma2")

set.seed(883)
model2a <- jags (data1, inits1, params2, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)

temp2a=apply(model2a$BUGSoutput$sims.array,3,unlist)

posterior_d0 <- temp2a[,12] 
posterior_m0 <- temp2a[,24] 
posterior_s2 <- temp2a[,47] 
posterior_d0 <- temp2a[,48]

# prior

data_prior <- list(mu.a = -2.752, mu.b = 9.028, sigma2.a = 0.1914062, sigma2.b = 0.21875, delta.a = 0.358, delta.b = 2.149, tau2.a = .0025, tau2.b = .005, N = 11, n = cbind(c(71,52,107,49,86,49,357,516,186,36,70),c(174,53,142,238,103,241,348,512,218,41,80)))
params_prior <- c("y","delta0","mu0","sigma2","tau2")
inits_prior <- rep((list(list(mu=rep(0,N), delta=rep(0,N),y = cbind(c(4,1,3,2,12,3,15,19,18,5,11),c(10,4,9,25,11,20,15,17,25,4,5))))),3)
 
set.seed(883)
model2b <- jags (data_prior, inits_prior, params_prior, "DAP1.txt", n.chains=3, n.iter=70000, n.burnin=0, n.thin=1, DIC=FALSE)


```



plot(density(main_parms2[,1]))
lines(density(prior_d0))
lines()

plot(density(main_parms2[,2]))
lines(density(prior_m0))

plot(density(main_parms2[,4]))
lines(density(prior_s2))

plot(density(1/(main_parms2[,3])))
lines(density(prior_t2))



prior_m0
prior_s2
prior_t2


CALCULATIONS
```{r}
############### m0 distribution
m0_mean <- log(0.06/0.94)

prec_10p<-0.04
m0_10p <- log(prec_10p/(1-prec_10p))
z.10 <- qnorm(0.1)

m0.sig <- (m0_10p-m0_mean)/z.10
m0.sig2 <- m0.sig^2
m0.prec <- 1/m0.sig2

# check quants
val <- seq(from=0.1,to=0.9,by=0.1)
quant.log <- qnorm(val,m0_mean,m0.sig)
quant.prob <- exp(quant.log)/(1+exp(quant.log))

m0.quant <- cbind(val,quant.log,quant.prob)
colnames(m0.quant) <- c("Quantile","Logit Scale","Probability Scale")

m0.quant


############### d0 distribution
d0_mean <- log((0.07/0.93)/(0.05/0.95))

d0_30 <- 0
z.30 <- qnorm(0.3)

d0.sig <- (d0_30-d0_mean)/z.30
d0.sig2 <- d0.sig^2
d0.prec <- 1/d0.sig2

qnorm(0.1,d0_mean,d0.sig)


############### sigma2 
m0_mean  
p_90 <- log(0.017/(1-0.017))

mean <- 1/sqrt(m0_mean-p_90)
var <- 10

################## SENSITIVITY ANALYSIS
##### DELTA1
# 1% and 11% OR 15% and 25%
log((0.01/0.99)/(0.11/0.89)) # 1% and 11%  
log((0.11/0.89)/(0.01/0.99)) # 11% and 1%
log((0.15/0.85)/(0.25/0.75)) # 11% and 1%



```




